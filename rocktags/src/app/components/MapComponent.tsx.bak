"use client";

import { useState } from "react";
import { GoogleMap, LoadScript, Marker, InfoWindow } from "@react-google-maps/api";
import type { Cat, Building, MapOptionsShape } from "../main/map/types";
import type { FC } from "react";

// Custom map style with your theme colors
const mapStyles = [
  {
    featureType: "poi",
    elementType: "labels",
    stylers: [{ visibility: "off" }],
  },
  {
    featureType: "transit",
    elementType: "labels",
    stylers: [{ visibility: "off" }],
  },
  {
    featureType: "road",
    elementType: "labels.icon",
    stylers: [{ visibility: "off" }],
  },
  {
    featureType: "poi.park",
    elementType: "geometry.fill",
    stylers: [{ color: "#E2C3A7" }], // Your theme color
  },
  {
    featureType: "landscape",
    elementType: "geometry",
    stylers: [{ color: "#F5E6D3" }], // Lighter version of your theme
  },
  {
    featureType: "road",
    elementType: "geometry",
    stylers: [{ color: "#ffffff" }],
  },
  {
    featureType: "road",
    elementType: "geometry.stroke",
    stylers: [{ color: "#e0e0e0" }],
  },
  {
    featureType: "water",
    elementType: "geometry",
    stylers: [{ color: "#A7D2E2" }], // Complementary blue color
  },
  {
    featureType: "poi.school",
    elementType: "geometry.fill",
    stylers: [{ color: "#E2C3A7" }], // Your theme color for buildings
  },
];

const libraries = ["places"];

// Cat icon using your theme colors
const catIcon = {
  url: "data:image/svg+xml;utf8,<svg width='48' height='48' viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg'><defs><linearGradient id='catGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23E2C3A7;stop-opacity:1' /><stop offset='100%25' style='stop-color:%23D4B094;stop-opacity:1' /></linearGradient><filter id='shadow'><feDropShadow dx='0' dy='2' stdDeviation='2' flood-opacity='0.3'/></filter></defs><circle cx='24' cy='24' r='20' fill='url(%23catGrad)' stroke='%23ffffff' stroke-width='3' filter='url(%23shadow)'/><ellipse cx='17' cy='22' rx='3' ry='4' fill='%23ffffff'/><ellipse cx='31' cy='22' rx='3' ry='4' fill='%23ffffff'/><circle cx='17' cy='22' r='1.5' fill='%23333333'/><circle cx='31' cy='22' r='1.5' fill='%23333333'/><path d='M18 30c2 3 10 3 12 0' stroke='%23ffffff' stroke-width='2.5' stroke-linecap='round'/><path d='M10 14l6 6M38 14l-6 6' stroke='%23D4B094' stroke-width='3' stroke-linecap='round' filter='url(%23shadow)'/><circle cx='24' cy='28' r='1.5' fill='%23D4B094'/></svg>",
  scaledSize: { width: 48, height: 48 },
};

// Building icon using your theme colors
const buildingIcon = {
  url: "data:image/svg+xml;utf8,<svg width='40' height='40' viewBox='0 0 40 40' fill='none' xmlns='http://www.w3.org/2000/svg'><defs><linearGradient id='buildGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%23E2C3A7;stop-opacity:1' /><stop offset='100%25' style='stop-color:%23D4B094;stop-opacity:1' /></linearGradient><filter id='bldgShadow'><feDropShadow dx='0' dy='2' stdDeviation='2' flood-opacity='0.4'/></filter></defs><rect x='8' y='10' width='24' height='26' rx='2' fill='url(%23buildGrad)' stroke='%23ffffff' stroke-width='2.5' filter='url(%23bldgShadow)'/><rect x='13' y='15' width='4' height='4' rx='1' fill='%23F5E6D3'/><rect x='13' y='21' width='4' height='4' rx='1' fill='%23F5E6D3'/><rect x='13' y='27' width='4' height='4' rx='1' fill='%23F5E6D3'/><rect x='23' y='15' width='4' height='4' rx='1' fill='%23F5E6D3'/><rect x='23' y='21' width='4' height='4' rx='1' fill='%23F5E6D3'/><rect x='18' y='28' width='4' height='8' rx='1' fill='%23D4B094'/><circle cx='20' cy='7' r='3' fill='%23F5E6D3' stroke='%23ffffff' stroke-width='1.5'/></svg>",
  scaledSize: { width: 40, height: 40 },
};

interface MapComponentProps {
  campusCats: Cat[];
  allBuildings: Building[];
  onCatClick: (cat: Cat) => void;
}

export default function MapComponent({ campusCats, allBuildings, onCatClick }: MapComponentProps) {
  const [activeCatIndex, setActiveCatIndex] = useState<number | null>(null);
  const [activeBuildingIndex, setActiveBuildingIndex] = useState<number | null>(null);
  const [currentZoom, setCurrentZoom] = useState<number>(16);

  const mapOptions: MapOptionsShape = {
    styles: mapStyles,
    zoomControl: true,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: true,
    minZoom: 15,
    maxZoom: 18,
    restriction: {
      latLngBounds: {
        north: 32.7480,
        south: 32.7220,
        east: -97.1000,
        west: -97.1250,
      },
      strictBounds: true,
    },
  } as any;

  const catMarkerIcon = createCatSVGIcon();
  const buildingMarkerIcon = createBuildingSVGIcon();

  const visibleBuildings = buildings.filter((building) => {
    if (currentZoom <= 15) return building.priority === 1;
    if (currentZoom <= 16) return building.priority <= 2;
    if (currentZoom <= 17) return building.priority <= 3;
    return true;
  });

  return (
    <GoogleMap
      mapContainerStyle={{ width: "100%", height: "100%" }}
      center={center}
      zoom={zoom}
      options={mapOptions}
      onZoomChanged={() => {
        // attempt to read zoom from window google maps instance
        try {
          const mapInstance = (window as any)?.google?.maps?.Map?.prototype ? null : null;
        } catch (e) {
          // noop
        }
      }}
    >
      {cats.map((cat) => (
        <Marker
          key={cat.id}
          position={{ lat: cat.lat, lng: cat.lng }}
          icon={catMarkerIcon}
          onClick={() => handleCatClick(cat)}
          onMouseOver={() => handleCatMouseOver(cat)}
          onMouseOut={handleCatMouseOut}
        />
      ))}

      {visibleBuildings.map((building) => (
        <Marker
          key={building.name}
          position={{ lat: building.lat, lng: building.lng }}
          icon={buildingMarkerIcon}
          onClick={() => onBuildingClick(building)}
        />
      ))}

      {hoveredCat && (
        <InfoWindow position={{ lat: hoveredCat.lat, lng: hoveredCat.lng }} onCloseClick={() => setHoveredCat(null)}>
          <div className="p-4 max-w-xs">
            <h3 className="text-lg font-bold text-[#847570] mb-2">{hoveredCat.name}</h3>
            <p className="text-sm text-[#847570] mb-2">
              <span className="font-medium">{(hoveredCat as any).personality}</span> â€¢ {(hoveredCat as any).age} years old
            </p>
            <div className="flex items-center space-x-2 text-sm text-[#E2C3A7]">
              <span>Best time: {(hoveredCat as any).bestTime || 'daytime'}</span>
            </div>
          </div>
        </InfoWindow>
      )}

      {selectedCat && (
        <InfoWindow position={{ lat: selectedCat.lat, lng: selectedCat.lng }} onCloseClick={onInfoWindowClose}>
          <div className="p-2 max-w-xs">
            <h3 className="text-lg font-bold text-[#4E2A17]">{selectedCat.name}</h3>
            <p className="text-sm text-[#847570]">{(selectedCat as any).activity || (selectedCat as any).bio}</p>
          </div>
        </InfoWindow>
      )}

      {selectedBuilding && (
        <InfoWindow position={{ lat: selectedBuilding.lat, lng: selectedBuilding.lng }} onCloseClick={onInfoWindowClose}>
          <div className="p-2 max-w-xs">
            <h3 className="text-lg font-bold text-[#847570]">{selectedBuilding.name}</h3>
            <p className="text-sm text-[#847570]">({selectedBuilding.abbr})</p>
          </div>
        </InfoWindow>
      )}
    </GoogleMap>
  );
};

export default MapComponent;
